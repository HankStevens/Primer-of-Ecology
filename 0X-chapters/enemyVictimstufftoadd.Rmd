



\subsection{Modeling data from \index{Bombay|see{Mumbai}}Bombay}
Here we try our hand at fitting the SIR model to some data. Kermack and McCormick \cite{Kermack:1927fk} provided data on the number of \index{plague}plague deaths per week in Bombay\footnote{Bombay is the coastal city now known as \index{Mumbai}Mumbai, and is the capital of Maharashtra; it is one of the largest cities in the world.} in 1905--06. We first enter them and look at them\footnote{Data provided kindly by S.P. Ellner}.
<<Ross, fig=TRUE>>=
data(ross)
plot(CumulativeDeaths ~ Week, data=ross)

@
\begin{figure}[ht]
  \centering
  \includegraphics[width=.6\textwidth]{FittedBombay}
  \caption{Cumulative deaths for plague, in Bombay, India, 1905--1906 (raw data and fitted model, as described in this section).}
  \label{fig:sir2}
\end{figure}

As with most such enterprises, we wish we knew far more than we do about the which depends on fleas, rodents, humans, and \emph{Yersinia pestis} on which the dynamics depend. To squeeze this real-life scenario  into a model with a small number of parameters requires a few assumptions.

% We begin by assuming, and Kermack and Mckendrick did, that mortality from bubonic plague, in Bombay, in 1905, was quite high, close to 90\%. Next, we realize that the only data we have is deaths. Given, however, that the mortality is very high, we might approximate the number of infections by saying that $Deaths = 0.9 \times Infections$. 

A good starting place is a simple SIR model for a population of constant size (eq. \ref{eq:SIR}) \cite{Ellner:2006qe, Kermack:1927fk}.

@ 
\subsubsection{Optimization}
We next want to let \R~find the most accurate estimates of our model parameters $\beta,\,\gamma$. The best and most accessible reference for this is Bolker \cite{Bolker:2008rr}. Please read the Appendix \ref{sec:numer-optim} for more explanation regarding optimization and objective functions.

Now we create the objective function. An objective function compares a model to data, and calculates a measure of fit (e.g., residual sum of squares, likelihood). Our objective function will calculate the likelihood\footnote{\emph{Likelihood} is the probability of data, given a particular model and its parameters.} of particular values for SIR model parameters. These parameters include  $\gamma$ and $\beta$ of the SIR model. The parameters will also include two other unknowns, (i) $N$, total relevant population size of Bombay at the time (1905--1906), and (ii) $I_0$, initial size of the infected population at our $t=0$. A survey of easily accessed census data suggests the population at the time was in the neighborhood of $\sim 10^6$ individuals. We also might assume that $I_0$ would be a very small number, perhaps $\sim 1$ in principle.

Some details about our objective function:
\begin{compactenum}
  \item Arguments are transformed parameters (this allows the optimizer to work on the logit\footnote{A logit is the transformation of a proportion which will linearize the logistic curve, logit (p) = $\log ( p/(1-p) )$.} and log scales).
    \item Transformed parameters are backtransformed to the scale of the model.
      \item Parameters are used to integrate the ODEs using \texttt{ode}, retaining only the resistant (i.e. dead) group (the fourth column of the output); this provides the \emph{predicted values} given the parameters and the time from onset, and the standard deviation of the residuals around the predicted values.
          \item  It returns the negative log-likelihood of the data, given the parameter values.
\end{compactenum}

Here is our objective function. Note that its last value is the negative sum of the log-probabilities of the data (given a particular realization of the model).
<<>>=
sirLL=function(logit.B, logit.g, log.N, log.I0) {
  parms <- c(B=plogis(logit.B), g=plogis(logit.g));
  x0 <- c(S=exp(log.N), I=exp(log.I0), R=0)
  Rs <- ode(y=x0, ross$Week, SIR, parms, hmax=.01)[,4]
  SD <- sqrt(sum( (ross$CumulativeDeaths -Rs)^2)/length(ross$Week) )
   -sum(dnorm(ross$CumulativeDeaths, mean=Rs, sd=SD, log=TRUE))
}
@ 
We then use this function, \texttt{sirLL}, to find the likelihood of the best parameters. The \texttt{mle2} function in the \texttt{bbmle} library\footnote{You will need to load the \texttt{bbmle} package from a convenient mirror, unless someone has already done this for the computer you are using. See the Appendix for details about packages (\ref{sec:where-r}) and optimization in \R~(\ref{sec:numer-optim}).} will minimize the negative log-likelihood generated by \texttt{sirLL}, and return values for the parameters of interest.

We will use a robust, but relatively slow method called Nelder-Mead (it is the default). We supply \texttt{mle2} with the objective function and a list of initial parameter values. This can take a few minutes.
<<echo=false, results=hide>>=
load("rossfits.Rdata")
@ 
<<eval=false>>=
require(bbmle)
fit <- mle2(sirLL, start=list(logit.B=qlogis(1e-5), logit.g=qlogis(.2), 
                     log.N=log(1e6), log.I0=log(1) ), method="Nelder-Mead")
<<sumfit>>=
summary(fit)
 
@ 
This gets us some parameter estimates, but subsequent attempts to actually get confidence intervals failed. This occurs frequently when we ask the computer to estimate too many, often correlated, parameters for a given data set. Therefore, we have to make assumptions regarding selected parameters. Let us assume for the time being that the two variable estimates are correct, that the population size of the vulnerable population was approximately exp(\Sexpr{round(coef(fit)[3],1)}) and the number of infections at the onset of the outbreak was \Sexpr{round(coef(fit)[4],1)}. We will hold these constant and ask \R~to refit the model, using the default method.
<<eval=false>>=
fit2 <- mle2(sirLL, start=as.list(coef(fit)),
            fixed=list(log.N=coef(fit)[3], log.I0=coef(fit)[4]), method="Nelder-Mead")
<<sumfit2>>=
summary(fit2)
@ 
Next we want to find confidence intervals for $\beta$ and $\gamma$. This can take \emph{several} minutes, but results in a likelihood profile for these parameters, which show the confidence regions for these parameters (Fig. \ref{fig:profile}). 
<<eval=false>>=
pr2 <- profile(fit2)
<<profileSIR, fig=TRUE, width=9, height=6>>=
par(mar=c(5,4,4,1))
plot(pr2)

<<eval=false,echo=false, results=hide>>=
save(fit,fit2,pr2, file="rossfits.Rdata")
@ 
We see that the confidence intervals for the transformed variables provide estimates of our confidence in these parameters.

\begin{figure}[ht]
  \centering
  \includegraphics[width=\linewidth]{profileSIR}
  \caption{Likelihood profile plots, indicating confidence intervals on transformed SIR model parameters.}
  \label{fig:profile}
\end{figure}

Last we get to plot our curve with the data. We first backtransform the coefficients of the objective function.
<<>>=
p <- as.numeric(c(plogis(coef(fit2)[1:2]),
       exp(coef(fit2)[3:4])) ); p
@ 
We then get ready to integrate the disease dynamics over this time period.
<<>>=
inits <- c(S = p[3], I=p[4], R=0)
params <- c(B=p[1], g=p[2])
SIR.Bombay <- data.frame( ode(inits, ross$Week, SIR, params) )
@ 
Last, we plot the model and the data (Fig. \ref{fig:sir2}).
<<FittedBombay, fig=TRUE>>=
matplot(SIR.Bombay[,1], SIR.Bombay[,3:4], type='l', col=1)
points(ross$Week, ross$CumulativeDeaths)
legend('topleft', c("I", "R"), lty=1:2, bty='n')
@
So, what does this mean (Fig. \ref{fig:sir2})? We might check what these values mean, against what we know about the reality. Our model predicts that logit of $\gamma$ was a confidence interval,
<<>>=
(CIs <- confint(pr2))
@ 
This corresponds to a confidence interval for $\gamma$ of 
<<>>=
(gs <- as.numeric(plogis(CIs[2,]) ))
@ 
Recall that the duration of the disease in the host is $1/\gamma$. Therefore, our model predicts a confidence interval for the duration (in days) of 
<<>>=
7*1/gs
@ 
Thus, based on this analysis, the duration of the disease is right around 9.5 days.  This seems to agree with what we know about the biology of the Bubonic plague. Its duration, in a human host, is typically thought to last 4--10 days. 



% Problems or Exercises should be sorted chapterwise
\section*{Problems}
\addcontentsline{toc}{section}{Problems}
%
% Use the following environment.
% Don't forget to label each problem;
% the label is needed for the solutions' environment
% \begin{prob}
% \label{prob1}
% The problem\footnote{Footnote} is described here. The
% problem is described here. The problem is described here.
% \end{prob}

% \begin{prob}
% \label{prob1}
% \textbf{Problem Heading}\\
% (a) The first part of the problem is described here.\\
% (b) The second part of the problem is described here.
% \end{prob}
\begin{prob}
\textbf{Lotka--Volterra Predator--prey Model}\\
(a) Write down the two species Lotka--Volterra predator--prey model.\\
(b) Describe how Fig. \ref{fig:LVDyn} illustrates neutral oscillatory dynamics.\\
(c) What are the units of the predator--prey model coefficients $b$, $a$, $e$, and $s$? How do we interpret them?\\
\end{prob}

\begin{prob}
\textbf{Rosenzweig-MacArthur Predator--prey Model}\\
(a) Write down the two species Rosenzweig-MacArthur predator--prey model.\\
(b) How do we interpret $b$, $K$, $w$, $D$, $e$ and $s$? What are their units?\\
(c) What is the value of the functional response when $H = D$? Explain how this result provides the meaning behind the name we use for $D$, the \emph{half saturation} constant.\\
(d) For each point A--D in Fig. \ref{fig:RMiso}, determine whether the growth rate for the predator and the herbivore are zero, positive, or negative.\\
(e) In what way is the Rosenzweig-MacArthur
predator isocline  (Fig. \ref{fig:RMiso}) similar to the
Lotka--Volterra model? It also differs from the Lotka--Volterra
isocline--explain the ecological interpretation of $D$ in the type II
functional response and its consequence for this isocline.\\
(f) Explain the interpretation of real and imaginary
parts of the eigenvalues for this paramterization of the
Rosenzweig-MacArthur predator--prey model.\\
(g)  In what ways does Fig. \ref{PPP}
match the interpretation of the eigenanalysis of this model?\\
(h) Examine the prey isoclines in Fig. \ref{PPP}. How you can tell
what the carrying capacities of the prey are?\\
(i) What do the above eigenanalyses tell us about how the stability of the predator--prey interaction varies with the carrying capacity of the prey?\\
(j) Consult Fig. \ref{PPP}. What is the
relation between the carrying capacity of the prey and the magnitude
of the oscillations? What is the relation between the carrying
capacity of the prey and the minimum population size? What does this interpretation imply about natural ecosystems?
\end{prob}

\begin{prob}
  \textbf{Effects of dispersion on host--parasitoid dynamics}\\
  (a) Demonstrate the effects of aggregation on host--parasitoid dynamics. Specifically, vary the magnitude of $k$ to find the effects on stability.\\
(b) Demonstrate the effects of $a$ on stability.\\
(c) Demonstrate the effects of $R$ on stability.
\end{prob}

\begin{prob}
  \textbf{Effects of age at onset and disease duration on outbreak periodicity}\\
  (a) Create three simulations showing how diseases of different durations influence the periodicity of the outbreaks.\\
(b) Create three simulations showing how the age at onset for different diseases influence the periodicity of the outbreaks.\\
(c) Consider which factor is more important in influencing outbreak interval. How do you measure the interval? What criteria would you use to determine ``importance''? How do the realities of age and duration influence your selection of criteria? Write a short essay that asserts a thesis, and then provides support based on this exercise.
\end{prob}

